#!/bin/bash
# Source: http://unix.stackexchange.com/a/24636/18876
# See also: dateutils.ddiff

set -u
DATE=dateex; type -t "$DATE" >/dev/null || DATE=date	# Use extended date parsing via dateex if available.

printUsage()
{
    cat <<HELPTEXT
Calculate difference between two DATEs or TIMEs / the passed DATE or TIME and
now, and print it in flexible units depending on the magnitude of the
difference.
HELPTEXT
    printf 'Usage: %q %s\n' "$(basename "$1")" 'DATE|TIME [DATE|TIME] [-?|-h|--help]'
}
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	--)		shift; break;;
	-*)		{ echo "ERROR: Unknown option \"$1\"!"; echo; printUsage "$0"; } >&2; exit 2;;
	*)		break;;
    esac
done
if [ $# -lt 1 -o $# -gt 2 ]; then
    printUsage "$0" >&2
    exit 2
fi


typeset d1; d1=$("$DATE" -d "$1" +%s) || exit 1
typeset d2; d2=$("$DATE" -d "${2:-}" +%s) || exit 1
typeset secondsDiff=$(( (d1-d2) > 0 ? (d1-d2) : (d2-d1)))
typeset daysDiff=$(( (secondsDiff + 43200) / 86400 ))

typeset -a diffInUnits=()
addDiffUnit()
{
    local diff=$1; shift
    [ "$diff" = 0 ] && return	# Skip values that are zero.
    local flooredDiff="${diff%.*}"
    [ ${#flooredDiff} -gt 4 ] && return	# Skip values that are too large (>9999).

    local unit=$1; shift
    local unitPlural='s'
    [ "$diff" = '1' ] && unitPlural=

    diffInUnits+=("$diff ${unit}${unitPlural}")
}
calculateUnit()
{
    local diff=$1; shift
    local unit=$1; shift
    local divisor=$1; shift
    local unitDiff="$(divround $((100 * diff / divisor)))"
    addDiffUnit "$unitDiff" "$unit"
}

addDiffUnit   "$secondsDiff" second
calculateUnit "$secondsDiff" minute 60
calculateUnit "$secondsDiff" hour 3600
calculateUnit "$secondsDiff" day 86400
calculateUnit "$daysDiff"    week 7
calculateUnit "$daysDiff"    month 30
calculateUnit "$daysDiff"    year 365
calculateUnit "$daysDiff"    generation 9131

joinBy ' = ' "${diffInUnits[@]}"
